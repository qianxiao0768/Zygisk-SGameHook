name: Build Zygisk-SGameHook Module
on:
  push:
    branches: [main]
    paths: ["module/**", ".github/workflows/**"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 1. 一键安装所有依赖+降级CMake（根治版本冲突）
      - name: Full Env Install
        run: |
          sudo apt update -y && sudo apt install -y zip unzip make gcc g++ git cmake=3.16.3-1ubuntu1 libc6-dev
          sudo update-alternatives --install /usr/bin/cmake cmake /usr/bin/cmake 100
          cmake --version
          chmod -R 777 ./*

      # 2. 下载解压NDK r25b（放弃action，手动安装100%生效）
      - name: Manual Install NDK r25b
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O ndk.zip
          unzip -q ndk.zip && rm -rf ndk.zip
          mv android-ndk-r25b $HOME/ndk
          echo "NDK=$HOME/ndk" >> $GITHUB_ENV
          echo "TOOLCHAIN=$HOME/ndk/toolchains/llvm/prebuilt/linux-x86_64" >> $GITHUB_ENV
          echo "PATH=$TOOLCHAIN/bin:$PATH" >> $GITHUB_ENV

      # 3. 编译核心指令（极简写法，根治所有参数报错）
      - name: Build libzygisk.so
        run: |
          cd module
          rm -rf build && mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DANDROID_ABI=arm64-v8a -DANDROID_PLATFORM=android-24
          make -j$(nproc)

      # 4. 打包Magisk模块（绝对路径，零路径报错）
      - name: Package Final Zip
        run: |
          mkdir -p $GITHUB_WORKSPACE/out
          cp $GITHUB_WORKSPACE/module/build/libzygisk.so $GITHUB_WORKSPACE/out/
          cp $GITHUB_WORKSPACE/module.prop $GITHUB_WORKSPACE/out/
          cp $GITHUB_WORKSPACE/customize.sh $GITHUB_WORKSPACE/out/
          cd $GITHUB_WORKSPACE/out && zip -9r ../Zygisk-SGameHook.zip *
          echo "✅ Build Success! File: $GITHUB_WORKSPACE/Zygisk-SGameHook.zip"

      # 5. 上传产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Zygisk-SGameHook-Final
          path: Zygisk-SGameHook.zip
