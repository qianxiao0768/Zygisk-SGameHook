name: Build Zygisk-SGameHook Module
on:
  push:
    branches: [ main ]
    paths:
      - 'module/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch: # 手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 关键修复1：配置NDK r26b（适配你的CMake版本，Zygisk模块最佳版本）
      - name: Setup Android NDK & SDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1

      # 关键修复2：配置环境变量，关联NDK/CMake
      - name: Env Config
        run: |
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "CMAKE_HOME=$ANDROID_HOME/cmake/3.22.1/bin" >> $GITHUB_ENV
          echo "$CMAKE_HOME" >> $GITHUB_PATH
          echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
          chmod -R 777 ./module
          echo "Env setup done!"

      # 关键修复3：使用CMake编译（你的项目原生编译方式，替代错误的assembleRelease）
      - name: Build Module (CMake)
        run: |
          cd module
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-24 \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      # 关键修复4：打包为Magisk可刷入的ZIP模块（自动打包，无需手动处理）
      - name: Package Magisk Module
        run: |
          cd module
          mkdir -p out
          # 复制编译产物+模块配置文件
          cp build/libs/libzygisk.so ./out/
          cp module.prop ./out/
          cp customize.sh ./out/
          cp sepolicy.rule ./out/ 2>/dev/null || true
          # 打包为zip（Magisk标准格式）
          zip -r Zygisk-SGameHook_$(date +%Y%m%d_%H%M%S).zip ./out/*
          mkdir -p ../release && mv *.zip ../release/
          echo "Build success! Module file: $(ls ../release/*.zip)"

      # 上传编译产物（可直接下载刷入）
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Zygisk-SGameHook-Module-Arm64
          path: release/*.zip
