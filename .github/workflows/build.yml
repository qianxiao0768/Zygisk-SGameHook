steps:
  - name: Checkout
    uses: actions/checkout@v4
    with:
      fetch-depth: 0

  - name: Set up Java 17
    uses: actions/setup-java@v4
    with:
      distribution: 'temurin'
      java-version: '17'

  - name: Cache Gradle
    uses: actions/cache@v4
    with:
      path: |
        ~/.gradle/caches
        ~/.gradle/wrapper
      key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}-${{ matrix.buildType }}
      restore-keys: |
        ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}-

  - name: Cache native .cxx build
    uses: actions/cache@v4
    with:
      path: module/.cxx
      key: ${{ runner.os }}-cxx-${{ matrix.buildType }}-${{ hashFiles('module/src/main/cpp/CMakeLists.txt') }}
      restore-keys: |
        ${{ runner.os }}-cxx-${{ matrix.buildType }}-

  - name: Set up Android SDK, NDK and CMake
    uses: android-actions/setup-android@v2
    with:
      api-level: 33
      build-tools: 33.0.2
      ndk-version: '25.2.9519653'      # 与 module/build.gradle 保持一致
      cmake-version: '3.22.1'          # 与 module/build.gradle 指定版本一致
      components: |
        platform-tools
        cmdline-tools;latest

  - name: Show env and ndk/cmake versions (debug)
    run: |
      echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
      $ANDROID_SDK_ROOT/cmake/3.22.1/bin/cmake --version || true
      $ANDROID_SDK_ROOT/ndk/25.2.9519653/ndk-build --version || true
      java -version

  - name: Ensure gradlew is executable
    run: chmod +x ./gradlew

  - name: Build (Gradle native + java)
    run: |
      echo "Building module (variant=${{ matrix.buildType }})"
      ./gradlew --no-daemon --parallel --max-workers=2 clean assemble${{ matrix.buildType }} \
        -Pandroid.injected.build.api=33 || ( echo 'Gradle build failed'; exit 1 )
    env:
      JAVA_TOOL_OPTIONS: -Xmx2g

  - name: Collect native libs & magisk zip
    run: |
      mkdir -p build-artifacts
      # 把 module 产物（可能的 zip）收集
      if [ -d module/out ]; then
        cp -r module/out build-artifacts/ || true
      fi
      # module/build 可能包含 outputs/intermediates（按 module/build.gradle）
      if [ -d module/build ]; then
        cp -r module/build build-artifacts/ || true
      fi
      # C++ 构建残留供调试
      if [ -d module/.cxx ]; then
        cp -r module/.cxx build-artifacts/ || true
      fi

  - name: Upload build artifacts
    uses: actions/upload-artifact@v4
    with:
      name: module-${{ matrix.buildType }}-artifacts
      path: build-artifacts/**