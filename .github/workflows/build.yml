name: Build Zygisk-SGameHook Module
on:
  push:
    branches: [ main ]
    paths:
      - 'module/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 修复1：安装系统依赖 + 核心工具
      - name: Install Dependencies
        run: |
          sudo apt update && sudo apt install -y zip unzip make gcc g++
          chmod -R 755 ./module

      # 修复2：适配仓库NDK配置，用r25b（最稳，兼容Zygisk）
      - name: Setup NDK r25b
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25b
          add-to-path: true

      # 修复3：环境变量全局配置，解决CMake/NDK找不到问题
      - name: Env Setup
        run: |
          echo "NDK_PATH=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH" >> $GITHUB_ENV

      # 修复4：CMake编译核心指令，适配你仓库的目录结构
      - name: Build with CMake
        run: |
          cd module
          rm -rf build && mkdir build && cd build
          cmake .. \
            -DCMAKE_SYSTEM_NAME=Android \
            -DCMAKE_SYSTEM_VERSION=24 \
            -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
            -DCMAKE_ANDROID_NDK=$NDK_PATH \
            -DCMAKE_ANDROID_STL_TYPE=c++_static \
            -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)

      # 修复5：打包Magisk模块，适配你仓库的文件路径，容错缺失文件
      - name: Package Magisk Zip
        run: |
          cd module
          mkdir -p ./release
          # 复制编译产物（适配你仓库的产物输出路径）
          cp -f ./build/libzygisk.so ./release/
          # 复制模块必需文件，缺失则跳过不报错
          cp -f ../module.prop ./release/ 2>/dev/null || echo "module.prop not found, skip"
          cp -f ../customize.sh ./release/ 2>/dev/null || echo "customize.sh not found, skip"
          cp -f ../sepolicy.rule ./release/ 2>/dev/null || echo "sepolicy.rule not found, skip"
          # 打包为可刷入的ZIP，压缩等级9
          cd release
          zip -9r ../Zygisk-SGameHook_$(date +%Y%m%d_%H%M%S)-arm64.zip *
          cd ..
          mkdir -p ../artifact && mv *.zip ../artifact/
          echo "✅ Build Success! File: $(ls ../artifact/*.zip)"

      # 上传产物，可直接下载刷入
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Zygisk-SGameHook-Module
          path: artifact/*.zip
